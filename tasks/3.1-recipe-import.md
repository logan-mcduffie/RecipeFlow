# Task 3.1: Recipe & Data Import Endpoints

**Phase**: 3 - Recipe Management API
**Status**: Not Started

## Summary

API endpoints to receive and store recipe data, item metadata, and icons from the companion mod using chunked/resumable uploads.

## Why This Matters

Receives the recipe dumps from the game and stores them for the flowchart editor. Must handle large payloads (50-200MB for icons) reliably.

## Inputs/Outputs

- **Input**: POST with modpack, version, recipes, item metadata, icons
- **Output**: Stored recipes and items, modpack version created/updated

## Technical Notes

### Endpoint 1: Recipe Sync

`POST /api/modpacks/:slug/versions/:version/recipes/sync`

**Auth required**: user must be authenticated

**Request payload** (GZIP compressed):
```json
{
  "contentHash": "sha256:...",
  "manifestHash": "sha256:...",
  "recipeCount": 5234,
  "recipes": [...]
}
```

**Response**:
```json
{
  "success": true,
  "stats": {
    "received": 5234,
    "new": 234,
    "updated": 12,
    "unchanged": 4988
  },
  "contentHash": "sha256:...",
  "version": "1.2.3"
}
```

### Endpoint 2: Chunked Upload Start

`POST /api/modpacks/:slug/versions/:version/upload/start`

**Request**:
```json
{
  "type": "icons" | "items",
  "totalSize": 52428800,
  "totalChunks": 10,
  "chunkSize": 5242880,
  "finalHash": "sha256:abc123..."
}
```

**Response**:
```json
{
  "sessionId": "uuid-here",
  "expiresAt": "2024-01-15T12:00:00Z"
}
```

### Endpoint 3: Upload Chunk

`POST /api/modpacks/:slug/versions/:version/upload/:sessionId/chunk/:chunkIndex`

**Headers**:
- `Content-Type: application/octet-stream`
- `X-Chunk-Hash: sha256:def456...`

**Body**: Binary chunk data

**Response**:
```json
{
  "chunkIndex": 5,
  "verified": true,
  "chunksReceived": 6,
  "chunksRemaining": 4
}
```

**Error Response** (hash mismatch):
```json
{
  "error": "HASH_MISMATCH",
  "expected": "sha256:def456...",
  "received": "sha256:xyz789...",
  "retryable": true
}
```

### Endpoint 4: Check Upload Status

`GET /api/modpacks/:slug/versions/:version/upload/:sessionId/status`

**Response**:
```json
{
  "sessionId": "uuid-here",
  "type": "icons",
  "chunksReceived": [0, 1, 2, 3, 4],
  "chunksMissing": [5, 6, 7, 8, 9],
  "totalChunks": 10,
  "expiresAt": "2024-01-15T12:00:00Z"
}
```

### Endpoint 5: Complete Upload

`POST /api/modpacks/:slug/versions/:version/upload/:sessionId/complete`

**Response** (success):
```json
{
  "success": true,
  "finalHashVerified": true,
  "itemsProcessed": 5234
}
```

**Response** (incomplete):
```json
{
  "success": false,
  "error": "CHUNKS_MISSING",
  "chunksMissing": [7, 8]
}
```

### Manifest Verification Flow

1. If modpack has CurseForge/Modrinth ID:
   - Fetch official manifest for this version from CF/Modrinth API
   - Compute expected manifest hash
   - Compare with user's manifestHash
2. If hashes match → mark as "verified", allow update to official version
3. If hashes don't match → create as "modified" variant, don't touch verified data
4. If no CF/Modrinth ID → accept as unverified community pack

### Item Metadata Processing

When items upload completes, process the JSON:
```json
{
  "items": [
    {
      "itemId": "gtceu:sodium_hydroxide_dust",
      "displayName": "Sodium Hydroxide Dust",
      "tooltip": ["Chemical Formula: NaOH", "Melting Point: 596K"]
    }
  ]
}
```

- Store in `items` table
- Link to modpack version
- Index by itemId for fast lookup

### Icon Processing

When icons upload completes:
- Extract zip/archive
- Store icons in file storage (local or S3)
- Generate icon URLs for items
- Match icons to items by filename convention (`gtceu_sodium_hydroxide_dust.png`)

### Upload Session Management

- Sessions expire after 1 hour
- Store chunks in temp storage until complete
- Clean up expired sessions via cron job
- Allow resume by checking session status

## Files to Touch

- `packages/api/src/routes/recipes.ts`
- `packages/api/src/routes/upload.ts`
- `packages/api/src/services/recipeImport.ts`
- `packages/api/src/services/uploadSession.ts`
- `packages/api/src/services/iconStorage.ts`
- `packages/api/src/services/itemImport.ts`
- `packages/shared/src/types/recipe.ts`
- `packages/shared/src/types/item.ts`

## Acceptance Criteria

- [ ] Recipe sync endpoint accepts payload
- [ ] Modpack version created if new
- [ ] Recipes stored with all metadata (including circuit for GT)
- [ ] **Chunked upload start endpoint works**
- [ ] **Chunk upload with hash verification works**
- [ ] **Upload status/resume endpoint works**
- [ ] **Upload complete with final hash verification works**
- [ ] **Item metadata stored (displayName, tooltip)**
- [ ] **Icons stored and accessible via URL**
- [ ] Duplicate imports handled gracefully
- [ ] Returns import summary (count, new, updated)
- [ ] Manifest verification works for CurseForge/Modrinth packs
- [ ] Modified packs stored separately from verified packs
- [ ] Synced_by user tracked on version
- [ ] Upload sessions expire and clean up properly
