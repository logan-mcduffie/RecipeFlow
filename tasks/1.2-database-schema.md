# Task 1.2: Database Schema Design

**Phase**: 1 - Project Setup & Infrastructure
**Status**: Not Started

## Summary

Design and implement PostgreSQL schema for modpacks, recipes, items, users, and flowcharts.

## Why This Matters

The schema must efficiently handle recipe data (JSONB), item metadata, support multiple modpack versions, and enable fast flowchart queries.

## Inputs/Outputs

- **Input**: Data model requirements
- **Output**: Prisma schema + migrations

## Technical Notes

- Use Prisma ORM for type safety
- Key tables:

### Core Tables

```prisma
model Modpack {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String
  description   String?
  curseforgeId  String?  @map("curseforge_id")
  modrinthId    String?  @map("modrinth_id")
  iconUrl       String?  @map("icon_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  versions      ModpackVersion[]

  @@map("modpacks")
}

model ModpackVersion {
  id            String   @id @default(cuid())
  modpackId     String   @map("modpack_id")
  version       String
  recipeHash    String?  @map("recipe_hash")
  manifestHash  String?  @map("manifest_hash")
  isVerified    Boolean  @default(false) @map("is_verified")
  syncedById    String?  @map("synced_by_id")
  syncedAt      DateTime? @map("synced_at")
  createdAt     DateTime @default(now()) @map("created_at")

  modpack       Modpack  @relation(fields: [modpackId], references: [id])
  syncedBy      User?    @relation(fields: [syncedById], references: [id])
  recipes       Recipe[]
  items         Item[]
  flowcharts    Flowchart[]

  @@unique([modpackId, version, manifestHash])
  @@map("modpack_versions")
}

model Recipe {
  id              String   @id @default(cuid())
  versionId       String   @map("version_id")
  recipeId        String   @map("recipe_id")  // e.g., "gtceu:chemical_reactor/sodium_hydroxide"
  type            String   // e.g., "gregtech:machine", "minecraft:crafting_shaped"
  sourceMod       String   @map("source_mod")
  data            Json     // Full recipe data as JSONB
  createdAt       DateTime @default(now()) @map("created_at")

  version         ModpackVersion @relation(fields: [versionId], references: [id])

  @@unique([versionId, recipeId])
  @@index([versionId])
  @@index([type])
  @@map("recipes")
}

model Item {
  id              String   @id @default(cuid())
  versionId       String   @map("version_id")
  itemId          String   @map("item_id")  // e.g., "gtceu:sodium_hydroxide_dust"
  displayName     String   @map("display_name")
  tooltip         String[] // Array of tooltip lines
  iconFilename    String?  @map("icon_filename")
  createdAt       DateTime @default(now()) @map("created_at")

  version         ModpackVersion @relation(fields: [versionId], references: [id])

  @@unique([versionId, itemId])
  @@index([versionId])
  @@index([displayName])
  @@map("items")
}

model User {
  id            String   @id @default(cuid())
  oauthProvider String   @map("oauth_provider")
  oauthId       String   @map("oauth_id")
  username      String
  email         String?
  avatar        String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  flowcharts    Flowchart[]
  syncedVersions ModpackVersion[]
  stars         Star[]

  @@unique([oauthProvider, oauthId])
  @@map("users")
}

model Flowchart {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  versionId     String   @map("version_id")
  name          String
  description   String?
  data          Json     // React Flow state as JSONB
  isPublic      Boolean  @default(false) @map("is_public")
  tags          String[]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id])
  version       ModpackVersion @relation(fields: [versionId], references: [id])
  stars         Star[]

  @@index([userId])
  @@index([versionId])
  @@index([isPublic])
  @@map("flowcharts")
}

model Star {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  flowchartId   String   @map("flowchart_id")
  createdAt     DateTime @default(now()) @map("created_at")

  user          User     @relation(fields: [userId], references: [id])
  flowchart     Flowchart @relation(fields: [flowchartId], references: [id])

  @@unique([userId, flowchartId])
  @@map("stars")
}

model UploadSession {
  id            String   @id @default(cuid())
  versionId     String   @map("version_id")
  userId        String   @map("user_id")
  type          String   // "icons" | "items"
  totalSize     Int      @map("total_size")
  totalChunks   Int      @map("total_chunks")
  chunkSize     Int      @map("chunk_size")
  finalHash     String   @map("final_hash")
  chunksReceived Int[]   @map("chunks_received")
  expiresAt     DateTime @map("expires_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@map("upload_sessions")
}
```

### Indexes

- `recipes`: Index on `versionId`, `type`, and GIN index on `data` for JSONB queries
- `items`: Index on `versionId`, `displayName` for full-text search
- `flowcharts`: Index on `versionId`, `isPublic` for gallery queries

### Manifest Verification Model

- Modpacks can be linked to CurseForge/Modrinth via project IDs
- When syncing, compare user's manifestHash against expected hash
- Mark versions as "verified" if they match, "modified" if they don't
- Track who synced each version (syncedById â†’ User)
- Modified versions stored with different manifestHash, not overwriting verified data

### Icon Storage

Icons are stored in filesystem or S3, not in database:
- Path pattern: `/icons/{modpackSlug}/{version}/{itemId_normalized}.png`
- `iconFilename` in `items` table references the file
- Serve via static file route or S3 CDN

## Files to Touch

- `packages/api/prisma/schema.prisma`
- `packages/api/prisma/migrations/*`

## Acceptance Criteria

- [ ] Prisma schema defined with all tables
- [ ] Migrations generated and run locally
- [ ] **Items table with displayName and tooltip**
- [ ] **UploadSession table for chunked uploads**
- [ ] Indexes on recipe and item queries
- [ ] Seed script for test data
- [ ] Basic CRUD operations verified
