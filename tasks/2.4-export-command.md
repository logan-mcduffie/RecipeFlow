# Task 2.4: Recipe Export Command

**Phase**: 2 - Companion Mod Development
**Status**: Not Started

## Summary

Implement `/recipeflow sync` command that sends recipes, item metadata, and icons to the web app using chunked/resumable uploads.

## Why This Matters

This is the bridge between the game and the web application. Large modpacks can have 50-200MB of data (icons especially), so reliable uploads with resume capability are essential.

## Inputs/Outputs

- **Input**: Player command
- **Output**: Recipes, item metadata, and icons sent to server

## Technical Notes

**Command**: `/recipeflow sync`

**Config stores**:
- Server URL
- Auth token
- Modpack slug

### Sync Process

```
1. Extract recipes (with circuit field for GT)
2. Compute manifestHash from mod list
3. Upload recipes (POST .../recipes/sync)
4. Start items upload session
5. Upload item metadata chunks (names, tooltips)
6. Complete items upload
7. Start icons upload session
8. Upload icon chunks
9. Complete icons upload
10. Show success to player
```

### Manifest Hash

Compute `manifestHash` to enable modpack verification:
1. Read `manifest.json` (CurseForge) or `pack.toml` (Modrinth)
2. Extract mod list (project IDs + file IDs or versions)
3. Sort alphabetically
4. SHA-256 hash the sorted list

### Chunked Upload Protocol

For large payloads, use chunked uploads with hash verification per chunk.

**Start session**:
```
POST /api/modpacks/:slug/versions/:version/upload/start
{
  "type": "icons" | "items",
  "totalSize": 52428800,
  "totalChunks": 10,
  "chunkSize": 5242880,
  "finalHash": "sha256:abc123..."
}
→ { "sessionId": "uuid-here" }
```

**Upload chunk**:
```
POST /api/modpacks/:slug/versions/:version/upload/:sessionId/chunk/:chunkIndex
Headers: X-Chunk-Hash: sha256:def456...
Body: [binary chunk data]
→ { "chunkIndex": 5, "verified": true, "chunksReceived": 6 }
```

**Check status (for resume)**:
```
GET /api/modpacks/:slug/versions/:version/upload/:sessionId/status
→ { "chunksReceived": [0,1,2,3,4], "chunksMissing": [5,6,7,8,9] }
```

**Complete upload**:
```
POST /api/modpacks/:slug/versions/:version/upload/:sessionId/complete
→ { "success": true, "finalHashVerified": true }
```

### Chunk Size Recommendations

| Payload Type | Chunk Size | Rationale |
|--------------|------------|-----------|
| Recipes JSON | 5 MB | Text compresses well |
| Item metadata | 2 MB | Smaller payload |
| Icons (zip) | 5 MB | Balance progress vs overhead |

### Progress Feedback

```
[RecipeFlow] Extracting recipes... 5,234 found
[RecipeFlow] Computing manifest hash...
[RecipeFlow] Uploading recipes... done (2.3 MB)
[RecipeFlow] Uploading item metadata... chunk 2/3
[RecipeFlow] Uploading item metadata... done
[RecipeFlow] Uploading icons... chunk 4/12 (33%)
[RecipeFlow] Uploading icons... chunk 8/12 (67%)
[RecipeFlow] Uploading icons... done (48.2 MB)
[RecipeFlow] Verifying upload integrity... passed
[RecipeFlow] ✓ Sync complete! 5,234 recipes, 4,891 items
```

### Resume on Failure

If upload is interrupted:
1. Check session status to get missing chunks
2. Resume uploading only missing chunks
3. Complete upload when all chunks received

### Error Handling

- Hash mismatch on chunk → retry that chunk
- Network failure → show resume command
- Auth failure → prompt for new token
- Server error → show error message with retry option

## Files to Touch

- `mod/core/command/SyncCommand.java`
- `mod/core/export/HttpExporter.java`
- `mod/core/export/ChunkedUploader.java`
- `mod/core/config/ModConfig.java`
- `mod/core/util/ManifestHasher.java`

## Acceptance Criteria

- [ ] Command works in-game
- [ ] Recipes sent successfully with GZIP compression
- [ ] **manifestHash computed and sent**
- [ ] **Item metadata (names + tooltips) uploaded**
- [ ] **Icons uploaded via chunked protocol**
- [ ] **Per-chunk hash verification**
- [ ] **Resume works after interrupted upload**
- [ ] Clear progress feedback to player (chunk X/Y)
- [ ] Error handling with useful messages
- [ ] Modpack version auto-detected
- [ ] Handles 50MB+ payloads reliably
